<!DOCTYPE html>
<html>
<head>
    <title>DTune Simple Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .debug {
            background: #e2e3e5;
            border: 1px solid #d6d8db;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>DTune Simple Test & Debug</h1>

    <div class="status loading" id="status">
        Ready for testing
    </div>

    <!-- SVG File Loading Section -->
    <div class="file-input">
        <h3>1. Load SVG File</h3>
        <input type="file" id="fileInput" accept=".svg" onchange="loadSVGFile(this)">
        <button class="btn-success" onclick="loadTestSVG()">Load Test SVG</button>
        <div id="fileStatus"></div>
    </div>

    <!-- Test Controls -->
    <div>
        <h3>2. Run Tests</h3>
        <button class="btn-primary" onclick="runBasicTests()">Run Basic Tests</button>
        <button class="btn-primary" onclick="runAdvancedTests()">Run Advanced Tests</button>
        <button class="btn-primary" onclick="debugLocalStorage()">Debug localStorage</button>
        <button class="btn-danger" onclick="clearData()">Clear All Data</button>
    </div>    <div id="output"></div>

    <script>
        let appLoaded = false;
        let testResults = [];
        let svgLoaded = false;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = 'debug';
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            output.appendChild(div);
            console.log(message);
        }

        // SVG File Loading Functions
        function loadSVGFile(input) {
            const file = input.files[0];
            if (!file) return;

            log('Loading SVG file: ' + file.name);
            const reader = new FileReader();

            reader.onload = function(e) {
                const svgContent = e.target.result;
                try {
                    // Use the app's file manager if available
                    const app = getAppReference();
                    if (app && app.fileManager) {
                        log('Using app file manager...');
                        app.fileManager.loadFromString(svgContent, file.name);
                        svgLoaded = true;
                        document.getElementById('fileStatus').innerHTML = '<span style="color: green;">‚úÖ SVG loaded successfully</span>';
                        log('‚úÖ SVG file loaded successfully');
                    } else {
                        log('‚ùå No file manager available - open this test from within the main app');
                        document.getElementById('fileStatus').innerHTML = '<span style="color: red;">‚ùå No app context - open from main app</span>';
                    }
                } catch (error) {
                    log('‚ùå Error loading SVG: ' + error.message);
                    document.getElementById('fileStatus').innerHTML = '<span style="color: red;">‚ùå Error: ' + error.message + '</span>';
                }
            };

            reader.readAsText(file);
        }

        function loadTestSVG() {
            log('Loading test SVG...');
            const testSVG = '<?xml version="1.0" encoding="UTF-8"?>' +
                '<svg width="400" height="300" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" xmlns:shaper="http://www.shapertools.com/namespaces/shaper">' +
                '<path d="M50,50 L150,50 L150,150 L50,150 Z" fill="none" stroke="black" stroke-width="1" shaper:cutType="online" shaper:cutDepth="3.0mm" shaper:cutOffset="0mm" shaper:toolDia="6.35mm" />' +
                '<circle cx="250" cy="100" r="40" fill="none" stroke="blue" stroke-width="2" shaper:cutType="inside" shaper:cutDepth="1.5mm" shaper:toolDia="3.175mm" />' +
                '<rect x="300" y="180" width="80" height="60" fill="none" stroke="red" stroke-width="1.5" shaper:cutType="pocket" shaper:cutDepth="5mm" shaper:cutOffset="1mm" shaper:toolDia="6mm" />' +
                '</svg>';

            try {
                const app = getAppReference();
                if (app && app.fileManager) {
                    log('Using app file manager...');
                    app.fileManager.loadFromString(testSVG, 'test-file.svg');
                    svgLoaded = true;
                    document.getElementById('fileStatus').innerHTML = '<span style="color: green;">‚úÖ Test SVG loaded successfully</span>';
                    log('‚úÖ Test SVG loaded successfully');
                } else {
                    log('‚ùå No file manager available - open this test from within the main app');
                    document.getElementById('fileStatus').innerHTML = '<span style="color: red;">‚ùå No app context available</span>';
                }
            } catch (error) {
                log('‚ùå Error loading test SVG: ' + error.message);
                document.getElementById('fileStatus').innerHTML = '<span style="color: red;">‚ùå Error: ' + error.message + '</span>';
            }
        }

        function setStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        // Try to detect if the main app is available
        function checkAppAvailability() {
            try {
                if (window.parent && window.parent.svgShaperEditor) {
                    log('‚úÖ App found in parent window');
                    return window.parent.svgShaperEditor;
                }

                if (window.svgShaperEditor) {
                    log('‚úÖ App found in current window');
                    return window.svgShaperEditor;
                }

                // Try to load from index.html directly
                log('‚ùå App not found, attempting to include scripts...');
                return null;
            } catch (error) {
                log('‚ùå Error checking app availability: ' + error.message);
                return null;
            }
        }

        function runBasicTests() {
            log('=== RUNNING BASIC TESTS ===');
            testResults = [];

            // Test 1: localStorage access
            try {
                const testKey = 'dtune-test-' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                log('‚úÖ localStorage is accessible');
                testResults.push({name: 'localStorage Access', status: 'PASS'});
            } catch (error) {
                log('‚ùå localStorage error: ' + error.message);
                testResults.push({name: 'localStorage Access', status: 'FAIL', error: error.message});
            }

            // Test 2: Check for existing localStorage data
            try {
                const savedSettings = localStorage.getItem('shaperEditorSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    log('‚úÖ Found existing localStorage data');
                    log('   - Units: ' + (settings.units || 'not set'));
                    log('   - Filename: ' + (settings.fileName || 'none'));
                    log('   - Element data count: ' + (settings.elementData ? settings.elementData.length : 0));

                    // Check for corruption
                    if (settings.originalSVG && typeof settings.originalSVG === 'string') {
                        try {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(settings.originalSVG, 'image/svg+xml');
                            const parseError = doc.querySelector('parsererror');

                            if (parseError) {
                                log('‚ùå CORRUPTED SVG DATA DETECTED!');
                                testResults.push({name: 'SVG Data Integrity', status: 'FAIL', error: 'Corrupted SVG in localStorage'});
                            } else {
                                log('‚úÖ SVG data appears valid');
                                testResults.push({name: 'SVG Data Integrity', status: 'PASS'});
                            }
                        } catch (svgError) {
                            log('‚ùå SVG parsing error: ' + svgError.message);
                            testResults.push({name: 'SVG Data Integrity', status: 'FAIL', error: svgError.message});
                        }
                    } else {
                        log('‚ÑπÔ∏è No SVG data in localStorage');
                        testResults.push({name: 'SVG Data Integrity', status: 'PASS'});
                    }
                } else {
                    log('‚ÑπÔ∏è No localStorage data found');
                    testResults.push({name: 'localStorage Data Check', status: 'PASS'});
                }
            } catch (error) {
                log('‚ùå localStorage data check failed: ' + error.message);
                testResults.push({name: 'localStorage Data Check', status: 'FAIL', error: error.message});
            }

            // Test 3: App availability
            const app = checkAppAvailability();
            if (app) {
                log('‚úÖ SVG Shaper Editor is available');
                testResults.push({name: 'App Availability', status: 'PASS'});

                // Test 4: MetaData
                try {
                    if (app.metaData) {
                        log('‚úÖ MetaData is available');
                        const elementDataMap = app.metaData.getElementDataMap();
                        log('   - Element data map size: ' + elementDataMap.size);
                        testResults.push({name: 'MetaData Check', status: 'PASS'});
                    } else {
                        log('‚ùå MetaData not available');
                        testResults.push({name: 'MetaData Check', status: 'FAIL', error: 'MetaData not found'});
                    }
                } catch (error) {
                    log('‚ùå MetaData check failed: ' + error.message);
                    testResults.push({name: 'MetaData Check', status: 'FAIL', error: error.message});
                }
            } else {
                log('‚ùå SVG Shaper Editor not found');
                testResults.push({name: 'App Availability', status: 'FAIL', error: 'App not loaded'});
            }

            // Summary
            const passCount = testResults.filter(r => r.status === 'PASS').length;
            const failCount = testResults.filter(r => r.status === 'FAIL').length;

            if (failCount === 0) {
                setStatus('All tests passed (' + passCount + '/' + testResults.length + ')', 'success');
            } else {
                setStatus('Some tests failed (' + passCount + '/' + testResults.length + ' passed)', 'error');
            }

            log('=== TEST COMPLETE: ' + passCount + ' passed, ' + failCount + ' failed ===');
        }

        function runAdvancedTests() {
            if (!svgLoaded) {
                log('‚ö†Ô∏è Please load an SVG file first before running advanced tests');
                setStatus('Load an SVG file first!', 'error');
                return;
            }

            log('=== RUNNING ADVANCED TESTS ===');
            testResults = [];

            // Get the app reference
            const app = getAppReference();
            if (!app) {
                log('‚ùå No app reference available');
                setStatus('No app context - open from main application', 'error');
                return;
            }

            // Test 1: Element data after SVG loading
            try {
                const elementDataMap = app.metaData.getElementDataMap();
                log('üìä ElementDataMap size after SVG load:', elementDataMap.size);

                if (elementDataMap.size > 0) {
                    log('‚úÖ Elements found in data map');
                    testResults.push({name: 'Element Data After Load', status: 'PASS'});

                    // Log element details
                    Array.from(elementDataMap.entries()).forEach(([appId, data]) => {
                        log(`   Element ${appId}: ${data.tagName}, shaper attrs: ${Object.keys(data.shaperAttributes || {}).length}`);
                    });
                } else {
                    log('‚ùå No elements found in data map');
                    testResults.push({name: 'Element Data After Load', status: 'FAIL', error: 'No elements'});
                }
            } catch (error) {
                log('‚ùå Element data test failed: ' + error.message);
                testResults.push({name: 'Element Data After Load', status: 'FAIL', error: error.message});
            }

            // Test 2: DOM elements with data-app-id
            try {
                const domElements = getAppDocument().querySelectorAll('[data-app-id]');
                log('üîç DOM elements with data-app-id:', domElements.length);

                if (domElements.length > 0) {
                    log('‚úÖ DOM elements have correct data-app-id attributes');
                    testResults.push({name: 'DOM Element IDs', status: 'PASS'});

                    // Test first element
                    const firstElement = domElements[0];
                    const appId = firstElement.dataset.appId;
                    log(`   First element appId: ${appId}`);

                    // Check if element manager can access it
                    const dimensions = app.elementManager.getElementDimensions(firstElement);
                    if (dimensions && Object.keys(dimensions).length > 0) {
                        log('‚úÖ ElementManager can access element data');
                        log('   Dimensions:', dimensions);
                        testResults.push({name: 'Element Manager Access', status: 'PASS'});
                    } else {
                        log('‚ùå ElementManager cannot access element data');
                        testResults.push({name: 'Element Manager Access', status: 'FAIL', error: 'No dimensions'});
                    }
                } else {
                    log('‚ùå No DOM elements with data-app-id found');
                    testResults.push({name: 'DOM Element IDs', status: 'FAIL', error: 'No elements'});
                }
            } catch (error) {
                log('‚ùå DOM element test failed: ' + error.message);
                testResults.push({name: 'DOM Element IDs', status: 'FAIL', error: error.message});
            }

            // Test 3: Dialog data simulation
            try {
                const domElements = getAppDocument().querySelectorAll('[data-app-id]');
                if (domElements.length > 0) {
                    const testElement = domElements[0];
                    log('üñ±Ô∏è Simulating dialog open for element:', testElement.dataset.appId);

                    const dimensions = app.elementManager.getElementDimensions(testElement);
                    const shaperAttrs = dimensions.shaperAttributes || {};

                    log('   Shaper attributes found:', Object.keys(shaperAttrs));

                    // Test conversion to display units
                    ['cutDepth', 'cutOffset', 'toolDia'].forEach(attr => {
                        const attrName = `shaper:${attr}`;
                        const value = shaperAttrs[attrName];
                        if (value && value.trim() !== '') {
                            const pixelValue = parseFloat(value);
                            if (!isNaN(pixelValue)) {
                                const convertedValue = app.measurementSystem.convertPixelsToCurrentUnit(pixelValue);
                                const formattedValue = app.measurementSystem.formatDisplayNumber(convertedValue);
                                log(`   ${attr}: ${value}px ‚Üí ${formattedValue}${app.measurementSystem.units}`);
                            }
                        } else {
                            log(`   ${attr}: (not set)`);
                        }
                    });

                    log('‚úÖ Dialog data simulation successful');
                    testResults.push({name: 'Dialog Data Simulation', status: 'PASS'});
                } else {
                    log('‚ùå No elements to test dialog with');
                    testResults.push({name: 'Dialog Data Simulation', status: 'FAIL', error: 'No elements'});
                }
            } catch (error) {
                log('‚ùå Dialog simulation failed: ' + error.message);
                testResults.push({name: 'Dialog Data Simulation', status: 'FAIL', error: error.message});
            }

            // Summary
            const passCount = testResults.filter(r => r.status === 'PASS').length;
            const failCount = testResults.filter(r => r.status === 'FAIL').length;

            if (failCount === 0) {
                setStatus('All advanced tests passed (' + passCount + '/' + testResults.length + ')', 'success');
            } else {
                setStatus('Some advanced tests failed (' + passCount + '/' + testResults.length + ' passed)', 'error');
            }

            log('=== ADVANCED TEST COMPLETE: ' + passCount + ' passed, ' + failCount + ' failed ===');
        }

        // Helper functions
        function getAppReference() {
            // Try multiple possible app references
            if (window.parent && (window.parent.shaperEditor || window.parent.svgShaperEditor)) {
                return window.parent.shaperEditor || window.parent.svgShaperEditor;
            }
            if (window.shaperEditor || window.svgShaperEditor) {
                return window.shaperEditor || window.svgShaperEditor;
            }
            return null;
        }

        function getAppDocument() {
            if (window.parent && window.parent.document) {
                return window.parent.document;
            }
            return document;
        }

        function debugLocalStorage() {
            log('=== DEBUGGING LOCALSTORAGE ===');

            try {
                const savedSettings = localStorage.getItem('shaperEditorSettings');
                if (!savedSettings) {
                    log('No localStorage data found');
                    return;
                }

                const settings = JSON.parse(savedSettings);
                log('Raw localStorage size: ' + savedSettings.length + ' characters');
                log('Parsed settings object keys: ' + Object.keys(settings).join(', '));

                if (settings.elementData) {
                    log('Element data entries: ' + settings.elementData.length);
                    settings.elementData.forEach((item, index) => {
                        log('  Element ' + index + ': appId=' + item.appId + ', tagName=' + (item.data ? item.data.tagName : 'unknown'));
                    });
                }

                log('Full localStorage content:');
                log(JSON.stringify(settings, null, 2));

            } catch (error) {
                log('‚ùå Error reading localStorage: ' + error.message);
            }
        }

        function clearData() {
            if (confirm('This will clear all localStorage data. Are you sure?')) {
                localStorage.clear();
                log('üßπ All localStorage cleared');
                setStatus('Data cleared - reload the page', 'success');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            setTimeout(() => {
                // Check if we have app context
                const app = getAppReference();
                if (app) {
                    setStatus('‚úÖ App context detected - ready for testing', 'success');
                    log('‚úÖ App context available, ready for full testing.');
                } else {
                    setStatus('‚ö†Ô∏è No app context - open this page from within the main application', 'loading');
                    log('‚ö†Ô∏è No app context. For full testing, open this from the main application.');
                }
            }, 500);
        });
    </script>
</body>
</html>