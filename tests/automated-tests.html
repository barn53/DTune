<!DOCTYPE html>
<html>
<head>
    <title>DTune Automated Tests</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-results { margin: 20px 0; }
        .test-pass { color: green; }
        .test-fail { color: red; }
        .test-section { margin: 15px 0; padding: 10px; border: 1px solid #ccc; }
        .debug-output { background: #f5f5f5; padding: 10px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>DTune Automated Tests</h1>
    <div id="test-results"></div>

    <!-- Hidden iframe to load the actual application -->
    <iframe id="app-frame" src="../index.html" style="display: none;"></iframe>

    <script>
        class DTuneTestFramework {
            constructor() {
                this.results = [];
                this.app = null;
                this.appDocument = null;

                // Add debugging output
                this.log('Test framework initialized');
            }

            log(message) {
                console.log('TEST:', message);
                // Also display in the page
                const resultsDiv = document.getElementById('test-results');
                if (resultsDiv) {
                    const logDiv = document.createElement('div');
                    logDiv.style.color = '#666';
                    logDiv.style.fontSize = '12px';
                    logDiv.textContent = new Date().toLocaleTimeString() + ' - ' + message;
                    resultsDiv.appendChild(logDiv);
                }
            }

            async waitForApp() {
                this.log('Waiting for app to load...');
                const frame = document.getElementById('app-frame');

                return new Promise((resolve, reject) => {
                    let timeoutId = setTimeout(() => {
                        this.log('❌ Timeout waiting for app to load');
                        reject(new Error('App loading timeout'));
                    }, 10000); // 10 second timeout

                    frame.onload = () => {
                        clearTimeout(timeoutId);
                        this.log('✅ Frame loaded, checking app...');

                        try {
                            this.app = frame.contentWindow;
                            this.appDocument = frame.contentDocument;

                            // Check if app exists
                            if (this.app && this.app.svgShaperEditor) {
                                this.log('✅ SVG Shaper Editor found');
                                setTimeout(resolve, 1000);
                            } else {
                                this.log('❌ SVG Shaper Editor not found in frame');
                                setTimeout(() => {
                                    // Try again after a delay
                                    if (this.app && this.app.svgShaperEditor) {
                                        this.log('✅ SVG Shaper Editor found on retry');
                                        resolve();
                                    } else {
                                        this.log('❌ SVG Shaper Editor still not found');
                                        reject(new Error('SVG Shaper Editor not found'));
                                    }
                                }, 2000);
                            }
                        } catch (error) {
                            this.log('❌ Error accessing frame content: ' + error.message);
                            reject(error);
                        }
                    };

                    frame.onerror = (error) => {
                        clearTimeout(timeoutId);
                        this.log('❌ Frame loading error: ' + error);
                        reject(new Error('Frame loading failed'));
                    };
                });
            }

            test(name, testFn) {
                try {
                    const result = testFn();
                    if (result === true || (result && result.then)) {
                        this.results.push({ name, status: 'PASS', result });
                        return result;
                    } else {
                        this.results.push({ name, status: 'FAIL', error: result || 'Test returned false' });
                        return false;
                    }
                } catch (error) {
                    this.results.push({ name, status: 'FAIL', error: error.message });
                    return false;
                }
            }

            async runTests() {
                this.log('=== Starting automated tests ===');

                try {
                    // Wait for app to load
                    await this.waitForApp();
                } catch (error) {
                    this.log('❌ Failed to load app: ' + error.message);
                    this.results.push({name: 'App Loading', status: 'FAIL', error: error.message});
                    this.displayResults();
                    return;
                }                // Test 1: Check if app loaded
                this.test('Application Loads', () => {
                    return this.app && this.app.svgShaperEditor;
                });

                // Test 2: Check MetaData initialization
                this.test('MetaData Initialized', () => {
                    return this.app.svgShaperEditor && this.app.svgShaperEditor.metaData;
                });

                // Test 3: Load test SVG file
                await this.test('Load Test SVG File', async () => {
                    if (!this.app.svgShaperEditor) return false;

                    // Clear localStorage first
                    this.app.localStorage.clear();

                    // Simulate file loading
                    const testSVG = '<?xml version="1.0" encoding="UTF-8"?>' +
                        '<svg width="400" height="300" viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" xmlns:shaper="http://www.shapertools.com/namespaces/shaper">' +
                        '<path d="M50,50 L150,50 L150,150 L50,150 Z" fill="none" stroke="black" stroke-width="1" shaper:cutType="online" shaper:cutDepth="3.0mm" shaper:cutOffset="0mm" shaper:toolDia="6.35mm" />' +
                        '</svg>';

                    // Use the app's file loading mechanism
                    try {
                        await this.app.svgShaperEditor.fileManager.loadFromString(testSVG, 'test.svg');
                        return true;
                    } catch (error) {
                        console.error('File loading failed:', error);
                        return false;
                    }
                });

                // Test 4: Check element data storage
                this.test('Element Data Storage', () => {
                    const elementDataMap = this.app.svgShaperEditor.metaData.getElementDataMap();
                    console.log('ElementDataMap size:', elementDataMap.size);
                    console.log('ElementDataMap entries:', Array.from(elementDataMap.entries()));
                    return elementDataMap.size > 0;
                });

                // Test 5: Check localStorage format
                this.test('LocalStorage Format', () => {
                    const savedSettings = this.app.localStorage.getItem('shaperEditorSettings');
                    if (!savedSettings) return false;

                    const settings = JSON.parse(savedSettings);
                    console.log('LocalStorage elementData:', settings.elementData);

                    // Check for correct format
                    if (settings.elementData && Array.isArray(settings.elementData)) {
                        const hasCorrectFormat = settings.elementData.every(item =>
                            item.appId && !item.appId.startsWith('element-') && item.data
                        );
                        return hasCorrectFormat;
                    }
                    return false;
                });

                // Test 6: Dialog data integrity
                this.test('Dialog Data Integrity', () => {
                    // Find an element with shaper attributes
                    const elementsWithAppId = this.appDocument.querySelectorAll('[data-app-id]');
                    console.log('Found elements with data-app-id:', elementsWithAppId.length);

                    if (elementsWithAppId.length === 0) return false;

                    const testElement = elementsWithAppId[0];
                    console.log('Test element appId:', testElement.dataset.appId);

                    // Check if element manager can get dimensions
                    const dimensions = this.app.svgShaperEditor.elementManager.getElementDimensions(testElement);
                    console.log('Element dimensions:', dimensions);

                    return dimensions && Object.keys(dimensions).length > 0;
                });

                // Test 7: Attribute modal data
                this.test('Attribute Modal Data', () => {
                    try {
                        const elementsWithAppId = this.appDocument.querySelectorAll('[data-app-id]');
                        if (elementsWithAppId.length === 0) return false;

                        const testElement = elementsWithAppId[0];

                        // Simulate opening the modal (without actually showing it)
                        const uiComponents = this.app.svgShaperEditor.uiComponents;
                        const dimensions = this.app.svgShaperEditor.elementManager.getElementDimensions(testElement);

                        console.log('Modal test - element:', testElement);
                        console.log('Modal test - appId:', testElement.dataset.appId);
                        console.log('Modal test - dimensions:', dimensions);

                        return dimensions && dimensions.shaperAttributes;
                    } catch (error) {
                        console.error('Modal test error:', error);
                        return false;
                    }
                });

                this.displayResults();
            }

            displayResults() {
                const resultsDiv = document.getElementById('test-results');
                let html = '<h2>Test Results</h2>';

                this.results.forEach(result => {
                    const className = result.status === 'PASS' ? 'test-pass' : 'test-fail';
                    html += '<div class="test-section">' +
                        '<strong class="' + className + '">' + result.status + '</strong>: ' + result.name +
                        (result.error ? '<div class="debug-output">Error: ' + result.error + '</div>' : '') +
                        '</div>';
                });

                resultsDiv.innerHTML = html;

                const passCount = this.results.filter(r => r.status === 'PASS').length;
                const totalCount = this.results.length;

                console.log('Tests completed: ' + passCount + '/' + totalCount + ' passed');
            }
        }

        // Run tests when page loads
        window.onload = async () => {
            const testFramework = new DTuneTestFramework();
            await testFramework.runTests();
        };
    </script>
</body>
</html>