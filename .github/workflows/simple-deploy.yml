name: Deploy SVG Editor

on:
  push:
    branches: [ release ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install build tools
        run: npm install html-minifier-terser terser clean-css-cli

      - name: Build single-file app
        run: |
          mkdir build

          # Combine all JavaScript files
          cat js/*.js > build/combined.js

          # Minify everything
          npx clean-css-cli styles.css -o build/styles.min.css
          npx terser build/combined.js -c -m -o build/app.min.js

          # Get git info for version tracking
          GIT_HASH=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          # Create final HTML with everything inline
          node -e "
          const fs = require('fs');
          let html = fs.readFileSync('index.html', 'utf8');
          const css = fs.readFileSync('build/styles.min.css', 'utf8');
          const js = fs.readFileSync('build/app.min.js', 'utf8');

          // Replace CSS link with inline styles
          html = html.replace('<link rel=\"stylesheet\" href=\"styles.css\">', '<style>' + css + '</style>');

          // Remove JS script tags and add inline script
          html = html.replace(/<script src=\"js\/[^\"]*\"><\/script>/g, '');
          html = html.replace('</body>', '<script>' + js + '</script></body>');

          fs.writeFileSync('build/index.html', html);
          "

          # Add version info to HTML
          cat >> build/version.js << EOF
          window.BUILD_INFO = {
            gitHash: "${GIT_HASH}",
            buildDate: "${BUILD_DATE}",
            version: "$(date +%Y%m%d)-${GIT_HASH}"
          };
          console.log("ðŸ“¦ App version:", window.BUILD_INFO.version);

          // Add visible version indicator
          setTimeout(() => {
            const v = document.createElement("div");
            v.style = "position:fixed;bottom:5px;right:5px;font-size:10px;opacity:0.6;z-index:9999;background:rgba(0,0,0,0.7);color:white;padding:2px 5px;border-radius:3px;font-family:monospace;";
            v.textContent = "v${GIT_HASH}";
            v.title = "Built: ${BUILD_DATE}";
            document.body.appendChild(v);
          }, 1000);
          EOF

          # Insert version script into HTML
          sed -i 's|</head>|<script>'"$(cat build/version.js)"'</script></head>|' build/index.html

          # Convert SVG icons to data URLs
          for icon in icons/*.svg; do
            if [ -f "$icon" ]; then
              name=$(basename "$icon")
              data="data:image/svg+xml;base64,$(base64 -w 0 < "$icon")"
              sed -i "s|icons/$name|$data|g" build/index.html
            fi
          done

          # Final HTML minification
          npx html-minifier-terser build/index.html \
            --collapse-whitespace \
            --remove-comments \
            --minify-css \
            --minify-js \
            -o build/final.html

          mv build/final.html build/index.html

          # Clean up temp files
          rm build/combined.js build/app.min.js build/styles.min.css build/version.js

          echo "âœ… Built single-file app: $(du -h build/index.html | cut -f1)"
          echo "ðŸ·ï¸  Version: $(date +%Y%m%d)-${GIT_HASH}"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
